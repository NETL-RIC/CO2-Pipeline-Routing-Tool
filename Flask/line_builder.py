import os

from osgeo import ogr, osr
from datetime import datetime

def get_file_name(file_path):
    """ Gets filename (no extension) from path with \\ not /
    """
    file_path_split = file_path.split('\\')
    file_name_and_extension = file_path_split[-1].rsplit('.', 1)
    return file_name_and_extension[0]

def CleanDatetime(datestring):
    """
    Replace unwanted characters in string with an underscore as needed

    :param string: in value
    :return: in value with replaced characters
    """
    replacements = [" ", "-", ":"]
    for r in replacements:
        datestring = datestring.replace(r,'_')

    if "." in datestring:
        datestring = datestring.split(".")[0]

    return(datestring)

def line_builder(coords):
    """
    Creates line shapefiles in WGS84 and saves to Flask/output_shapefiles
    These are used by the PDF report builder, and turned into a zip for user-download in _____

    :param coords: list of coordinates as tuples in WGS 84
    :return: out_shp: string with 'output_shapefiles' + name of the file
    """
    # Set line geometry
    line = ogr.Geometry(ogr.wkbLineString)
    for c in coords:
        line.AddPoint(c[1], c[0])

    out_shp = os.path.abspath("output")     # name of dir to save shapefiles to
    out_shp = os.path.join(out_shp, f"route_{CleanDatetime(str(datetime.now()))}.shp")
    srs = osr.SpatialReference()
    srs.ImportFromEPSG(4326) #WGS84

    driver = ogr.GetDriverByName('Esri Shapefile')
    ds = driver.CreateDataSource(out_shp)
    lyr = ds.CreateLayer(out_shp, srs, geom_type=ogr.wkbLineString)

    featureDefn = lyr.GetLayerDefn()
    feature = ogr.Feature(featureDefn)
    feature.SetGeometry(line)
    lyr.CreateFeature(feature)

    ds.Destroy()

    out_shp_abspath = out_shp
    out_shp_filename = get_file_name(out_shp_abspath)
    return [out_shp_filename, out_shp_abspath]

# Input coordinates as ordered list of tuples in WGS84
# This is just test data
coords = [(38.79021683721502, -106.6822230701482), (38.79021683721502, -106.52931842587321),
          (38.79021683721502, -106.37641378159823), (38.79021683721502, -106.22350913732326),
          (38.79021683721502, -106.07060449304828), (38.79021683721502, -105.9176998487733),
          (38.79021683721502, -105.76479520449833), (38.79021683721502, -105.61189056022334),
          (38.79021683721502, -105.45898591594838), (38.79021683721502, -105.30608127167339),
          (38.79021683721502, -105.15317662739841), (38.79021683721502, -105.00027198312344),
          (38.79021683721502, -104.84736733884846), (38.79021683721502, -104.69446269457347),
          (38.79021683721502, -104.5415580502985), (38.79021683721502, -104.38865340602352),
          (38.79021683721502, -104.23574876174855), (38.79021683721502, -104.08284411747357),
          (38.79021683721502, -103.92993947319859), (38.79021683721502, -103.77703482892362),
          (38.79021683721502, -103.62413018464864), (38.79021683721502, -103.47122554037365),
          (38.79021683721502, -103.31832089609868), (38.79021683721502, -103.1654162518237),
          (38.79021683721502, -103.01251160754873), (38.79021683721502, -102.85960696327375),
          (38.79021683721502, -102.70670231899877), (38.79021683721502, -102.5537976747238),
          (38.79021683721502, -102.40089303044881), (38.79021683721502, -102.24798838617383),
          (38.79021683721502, -102.09508374189886), (38.79021683721502, -101.94217909762388),
          (38.79021683721502, -101.78927445334891), (38.79021683721502, -101.63636980907393),
          (38.79021683721502, -101.48346516479894), (38.79021683721502, -101.33056052052397),
          (38.79021683721502, -101.17765587624899), (38.79021683721502, -101.02475123197402),
          (38.79021683721502, -100.87184658769904), (38.79021683721502, -100.71894194342406),
          (38.79021683721502, -100.56603729914909), (38.79021683721502, -100.4131326548741),
          (38.79021683721502, -100.26022801059912), (38.79021683721502, -100.10732336632415),
          (38.79021683721502, -99.95441872204917), (38.79021683721502, -99.8015140777742),
          (38.79021683721502, -99.64860943349922), (38.79021683721502, -99.49570478922423),
          (38.79021683721502, -99.34280014494927), (38.79021683721502, -99.18989550067428),
          (38.79021683721502, -99.0369908563993), (38.79021683721502, -98.88408621212433),
          (38.79021683721502, -98.73118156784935), (38.79021683721502, -98.57827692357438),
          (38.79021683721502, -98.4253722792994), (38.79021683721502, -98.27246763502441),
          (38.79021683721502, -98.11956299074944), (38.79021683721502, -97.96665834647446),
          (38.79021683721502, -97.81375370219948), (38.79021683721502, -97.66084905792451),
          (38.79021683721502, -97.50794441364953), (38.79021683721502, -97.35503976937456),
          (38.79021683721502, -97.20213512509957), (38.79021683721502, -97.04923048082459),
          (38.79021683721502, -96.89632583654962), (38.79021683721502, -96.74342119227464),
          (38.79021683721502, -96.59051654799966), (38.79021683721502, -96.43761190372469),
          (38.79021683721502, -96.2847072594497), (38.79021683721502, -96.13180261517473),
          (38.79021683721502, -95.97889797089975), (38.79021683721502, -95.82599332662477),
          (38.79021683721502, -95.6730886823498), (38.79021683721502, -95.52018403807482),
          (38.79021683721502, -95.36727939379983), (38.79021683721502, -95.21437474952486),
          (38.79021683721502, -95.06147010524988), (38.79021683721502, -94.90856546097491),
          (38.79021683721502, -94.75566081669993), (38.79021683721502, -94.60275617242495),
          (38.79021683721502, -94.44985152814998), (38.79021683721502, -94.296946883875),
          (38.79021683721502, -94.14404223960001), (38.79021683721502, -93.99113759532504),
          (38.79021683721502, -93.83823295105006), (38.79021683721502, -93.68532830677509),
          (38.79021683721502, -93.53242366250011), (38.79021683721502, -93.37951901822512),
          (38.79021683721502, -93.22661437395016), (38.637312192940044, -93.37951901822512),
          (38.637312192940044, -93.22661437395016), (38.48440754866507, -93.37951901822512),
          (38.48440754866507, -93.22661437395016), (38.48440754866507, -93.07370972967517),
          (38.33150290439009, -93.22661437395016), (38.17859826011511, -93.37951901822512),
          (38.02569361584013, -93.53242366250011), (38.02569361584013, -93.37951901822512),
          (37.87278897156516, -93.53242366250011), (37.71988432729018, -93.68532830677509),
          (37.5669796830152, -93.83823295105006), (37.5669796830152, -93.68532830677509),
          (37.41407503874022, -93.83823295105006), (37.261170394465246, -93.99113759532504),
          (37.10826575019027, -94.14404223960001), (37.10826575019027, -93.99113759532504),
          (37.10826575019027, -93.83823295105006), (37.10826575019027, -93.68532830677509),
          (37.10826575019027, -93.53242366250011), (36.95536110591529, -93.68532830677509),
          (36.80245646164031, -93.83823295105006), (36.80245646164031, -93.68532830677509),
          (36.649551817365335, -93.83823295105006), (36.49664717309036, -93.99113759532504),
          (36.343742528815376, -94.14404223960001), (36.343742528815376, -93.99113759532504),
          (36.343742528815376, -93.83823295105006), (36.1908378845404, -93.99113759532504),
          (36.037933240265424, -93.99113759532504), (36.037933240265424, -93.83823295105006),
          (35.88502859599045, -93.99113759532504), (35.732123951715465, -94.14404223960001)]
          
# line_builder(coords)

